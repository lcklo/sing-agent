name: Build Go Project and Publish Releases

on:
  push:
    branches:
      - main

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Up Go Environment
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      # 新增步骤：自动创建 Git Tag（基于提交哈希+时间戳，避免冲突）
      - name: Create Auto Git Tag
        id: create-tag
        run: |
          COMMIT_HASH="${GITHUB_SHA::8}"
          BUILD_TIME="$(date +%Y%m%d%H%M%S)"
          AUTO_TAG="auto-${COMMIT_HASH}-${BUILD_TIME}"
          
          # 配置 Git 身份（否则无法提交 Tag）
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 创建并推送 Tag 到远程仓库
          git tag ${AUTO_TAG}
          git push origin ${AUTO_TAG}
          
          # 输出 Tag 名称
          echo "auto_tag=${AUTO_TAG}" >> $GITHUB_OUTPUT

      - name: Build Go Binary
        id: build
        run: |
          PROJECT_NAME="$(basename ${GITHUB_REPOSITORY})"
          AUTO_TAG="${{ steps.create-tag.outputs.auto_tag }}"
          OUTPUT_DIR="./dist"

          mkdir -p ${OUTPUT_DIR}

          # 跨平台构建（略，同之前配置）
          GOOS=linux GOARCH=amd64 go build -ldflags "-s -w" -o ${OUTPUT_DIR}/${PROJECT_NAME}-${AUTO_TAG}-linux-amd64 ./
          GOOS=linux GOARCH=arm64 go build -ldflags "-s -w" -o ${OUTPUT_DIR}/${PROJECT_NAME}-${AUTO_TAG}-linux-arm64 ./
          GOOS=windows GOARCH=amd64 go build -ldflags "-s -w" -o ${OUTPUT_DIR}/${PROJECT_NAME}-${AUTO_TAG}-windows-amd64.exe ./
          GOOS=darwin GOARCH=amd64 go build -ldflags "-s -w" -o ${OUTPUT_DIR}/${PROJECT_NAME}-${AUTO_TAG}-darwin-amd64 ./
          GOOS=darwin GOARCH=arm64 go build -ldflags "-s -w" -o ${OUTPUT_DIR}/${PROJECT_NAME}-${AUTO_TAG}-darwin-arm64 ./

          # 压缩产物（略，同之前配置）
          cd ${OUTPUT_DIR}
          for file in *; do
            if [ -f "$file" ]; then
              if [[ "$file" == *.exe ]]; then
                zip ${file}.zip ${file}
              else
                tar -zcvf ${file}.tar.gz ${file}
              fi
              rm -f ${file}
            fi
          done

          echo "output_dir=${OUTPUT_DIR}" >> $GITHUB_OUTPUT

      - name: Create and Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.create-tag.outputs.auto_tag }}  # 指定自动创建的 Tag
          name: Auto Release ${{ steps.create-tag.outputs.auto_tag }}
          body: |
            ## 自动创建的 Release（基于代码提交）
            - 提交哈希：${GITHUB_SHA}
            - 构建时间：$(date +%Y-%m-%d %H:%M:%S)
          files: ${{ steps.build.outputs.output_dir }}/*
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
