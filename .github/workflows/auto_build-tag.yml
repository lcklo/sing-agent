name: Build and Release

# 触发条件：当推送以 v 开头的 Tag 时触发（例如 v1.0.0、v2.1.3）
on:
  push:
    tags:
      - 'v*'

# 定义工作流的权限（用于创建 Release 和上传产物）
permissions:
  contents: write

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest
    strategy:
      # 多平台编译矩阵：可根据需要增删平台
      matrix:
        goos: [linux, windows, darwin]
        goarch: [amd64, arm64]
        # 排除不兼容的组合（例如 darwin/386 已废弃）
        exclude:
          - goos: windows
            goarch: arm64

    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 拉取完整历史，确保能获取 Tag 信息

      # 2. 设置 Go 环境
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25' # 替换为你的项目 Go 版本
          cache: true # 启用 Go 模块缓存，加速构建

      # 3. 构建可执行文件
      - name: Build
        env:
          # 从 Tag 中提取版本号（去掉前缀 v）
          VERSION: ${{ github.ref_name }}
          # 平台和架构变量
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          # 定义输出文件名（区分平台）
          BINARY_NAME="sing-agent_${VERSION}_${GOOS}_${GOARCH}"
          # Windows 系统添加 .exe 后缀
          if [ "$GOOS" = "windows" ]; then
            BINARY_NAME+=".exe"
          fi
          # 编译 Go 程序（添加版本信息到程序中）
          go build -ldflags "-X main.version=${VERSION}" -o "${BINARY_NAME}" ./...
          # 压缩产物（方便上传）
          if [ "$GOOS" = "windows" ]; then
            zip "${BINARY_NAME}.zip" "${BINARY_NAME}"
          else
            tar -czf "${BINARY_NAME}.tar.gz" "${BINARY_NAME}"
          fi

      # 4. 创建 Release 并上传产物
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          # 上传编译产物（匹配所有平台的压缩包）
          files: |
            *.zip
            *.tar.gz
          # 自动生成 Release 说明（也可手动指定 body）
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub 自动提供的令牌
